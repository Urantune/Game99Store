<!doctype html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>Profile User</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" th:href="@{/Accest/css/ProfileUser.css}">
</head>
<body>
<div class="container">
    <div class="card bg-dark text-light p-3 rounded-3 shadow" style="flex:1;">
        <div class="avatar text-center">
            <img src="/img/demo.jpg" alt="Avatar" id="currentAvatar" class="rounded-circle" style="width:120px;height:120px;object-fit:cover;border:2px solid #666;cursor:pointer;">
        </div>

        <div class="d-flex align-items-center justify-content-center mt-2">
            <h2 id="displayName" class="m-0" style="font-size:1.5rem;" th:text="${user.username}">User Name</h2>
        </div>

        <div class="modal fade" id="avatarModal" tabindex="-1" aria-labelledby="avatarModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content bg-dark text-light">
                    <div class="modal-header">
                        <h5 class="modal-title" id="avatarModalLabel">Ch·ªçn ·∫£nh ƒë·∫°i di·ªán</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-center">
                        <form id="avatarForm">
                            <div class="d-flex flex-wrap justify-content-center gap-2" id="avatarOptions"></div>
                            <button type="submit" class="btn btn-success mt-3">L∆∞u ·∫£nh</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="info mt-3">
            <p>Email: <span id="emailMasked" th:text="${user.getEmail()}"></span></p>
            <p>
                S·ªë ƒëi·ªán tho·∫°i: <span id="phoneDisplay">----------</span>
                <button type="button" class="btn btn-sm btn-outline-light" data-bs-toggle="modal" data-bs-target="#editPhoneModal">‚öôÔ∏è</button>
            </p>
            <p>
                Qu·ªëc gia: <span id="countryDisplay">----------</span>
                <button type="button" class="btn btn-sm btn-outline-light" data-bs-toggle="modal" data-bs-target="#editCountryModal">‚öôÔ∏è</button>
            </p>
            <p>B·∫£o m·∫≠t: <span style="color:gray">‚Äî</span></p>
            <a th:href="@{/logout}" href="/logout" class="btn btn-outline-danger mt-2">ƒêƒÉng xu·∫•t</a>
        </div>
    </div>

    <div class="card" style="flex:2;">
        <h2>üéÆ Th∆∞ vi·ªán game</h2>
        <div class="games" id="gameLibrary">
            <div class="game-card" th:each="a : ${listGame}" th:with="imgs=${a.linkImage}">
                <div style="width:140px; height:84px; overflow:hidden;">
                    <img th:src="${#arrays.length(imgs) > 4 ? '/' + imgs[4] : '/img/notfound.png'}" style="width:100%; height:100%; object-fit:cover;">
                </div>
                <p th:text="${a.gameName}">CS:GO</p>
            </div>
        </div>

        <h2 style="margin-top:20px;">üèÜ Th√†nh t√≠ch</h2>
        <div class="achievements">
            <ul id="achievementList">
                <li>üî• Ho√†n th√†nh 100 gi·ªù ch∆°i GTA V</li>
                <li>üéØ Rank Immortal trong Dota 2</li>
                <li>‚ö° MVP 50 tr·∫≠n trong CS:GO</li>
            </ul>
        </div>
    </div>

    <div style="flex:1;">
        <div id="walletCard" class="card wallet text-center p-4 shadow-lg" style="cursor:pointer;transition:transform .3s;">
            <h2 class="mb-2" style="color:#222;">üí∞ V√≠ GamePay</h2>
            <p class="text-muted mb-0" id="walletStatus">Ch∆∞a k√≠ch ho·∫°t</p>
        </div>

        <div id="activateWalletModal" class="modal fade" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content p-4 achievement">
                    <h4 class="text-center mb-3" style="color:#ffcd39;">V√≠ GamePay</h4>
                    <p>Li√™n k·∫øt ƒë·ªÉ t·∫≠n h∆∞·ªüng nhi·ªÅu ∆∞u ƒë√£i h∆°n!</p>
                    <p class="text-white">
                        B·∫±ng vi·ªác ch·ªçn "K√≠ch ho·∫°t", b·∫°n ƒë·ªìng √Ω li√™n k·∫øt t√†i kho·∫£n GameStore v·ªõi t√†i kho·∫£n GamePay c·ªßa b·∫°n theo
                        <a th:href="@{/terms}" href="/TermsOfService">ƒêi·ªÅu kho·∫£n d·ªãch v·ª•</a> v√†
                        <a th:href="@{/privacy}" href="/PrivacyPolicy">Ch√≠nh s√°ch b·∫£o m·∫≠t</a>.
                    </p>
                    <form id="activateWalletForm">
                        <div class="mb-3">
                            <label class="form-label">M·∫≠t kh·∫©u k√≠ch ho·∫°t v√≠</label>
                            <input type="password" maxlength="4" pattern="\d{4}" class="form-control text-center fw-bold" id="pinCode" name="pinCode" required placeholder="****">
                        </div>
                        <div class="text-center">
                            <button type="submit" class="btn btn-success px-4">K√≠ch ho·∫°t</button>
                            <button type="button" class="btn btn-secondary ms-2" data-bs-dismiss="modal">H·ªßy</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div id="pinPopup" class="modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);justify-content:center;align-items:center;">
            <div style="background:radial-gradient(circle at top,#19002b 0%,#0a0a0a 100%);padding:30px;border-radius:10px;width:350px;text-align:center;">
                <h5 style="color:#ffcd39;">V√≠ GamePay</h5>
                <p class="text-white">Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u c·ªßa v√≠</p>
                <input type="password" id="walletPin" maxlength="4" class="form-control mb-3 text-center" style="letter-spacing:5px;font-size:20px;">
                <div id="pinError" class="text-danger mb-2"></div>
                <button class="btn btn-primary px-4" id="verifyPinBtn">X√°c nh·∫≠n</button>
                <button class="btn btn-secondary px-3" id="closePinBtn">H·ªßy</button>
            </div>
        </div>

        <div id="toast" class="toast-message"></div>

        <div class="card transactions mt-3">
            <h2>üßæ Th√¥ng tin</h2>
            <h5 class="mt-2 text-white">1. L·ªãch s·ª≠ giao d·ªãch</h5>
            <h5 class="mt-3 text-white">2. Game ƒë√£ mua</h5>
            <h5 class="mt-3 text-white">3. Y√™u c·∫ßu ho√†n ti·ªÅn</h5>
            <h5 class="mt-3 text-white">4. Giao d·ªãch ƒëang x·ª≠ l√Ω</h5>
            <h5 class="mt-3 text-white">5. Th√¥ng b√°o</h5>
        </div>

        <div class="card settings">
            <h2>‚öôÔ∏è C√†i ƒë·∫∑t</h2>
            <button id="btnChangePassword">ƒê·ªïi m·∫≠t kh·∫©u</button>
            <button id="btnManageContact">Qu·∫£n l√Ω Email/Phone</button>
            <button id="btnToggle2FA">B·∫≠t/T·∫Øt 2FA</button>
            <button id="btnPrivacy">C√†i ƒë·∫∑t ri√™ng t∆∞</button>
        </div>
    </div>
</div>

<div class="modal fade" id="editNameModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header text-white">
                <h5 class="modal-title">ƒê·ªïi t√™n hi·ªÉn th·ªã</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="text" id="newName" class="form-control" value="">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" id="saveNameBtn" data-bs-dismiss="modal">L∆∞u</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editPhoneModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="text" id="newPhone" class="form-control" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" id="savePhoneBtn" data-bs-dismiss="modal">L∆∞u</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editCountryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Ch·ªçn qu·ªëc gia</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <select id="newCountry" class="form-select">
                    <option value="">-- Ch·ªçn qu·ªëc gia --</option>
                    <option value="Vi·ªát Nam">Vi·ªát Nam</option>
                    <option value="Hoa K·ª≥">Hoa K·ª≥</option>
                    <option value="Nh·∫≠t B·∫£n">Nh·∫≠t B·∫£n</option>
                    <option value="H√†n Qu·ªëc">H√†n Qu·ªëc</option>
                    <option value="Ph√°p">Ph√°p</option>
                    <option value="Anh">Anh</option>
                </select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" id="saveCountryBtn" data-bs-dismiss="modal">L∆∞u</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const STORAGE_KEYS = {
        name: 'gs_profile_name',
        email: 'gs_profile_email',
        phone: 'gs_profile_phone',
        country: 'gs_profile_country',
        avatar: 'gs_profile_avatar',
        walletPin: 'gs_wallet_pin',
        walletActive: 'gs_wallet_active'
    };

    const DEFAULTS = {
        name: 'Do Trong Tri',
        email: 'user@example.com',
        phone: '',
        country: '',
        avatars: ['/img/demo1.jpg','/img/demo3.jpg','/img/demo4.jpg','/img/a.png']
    };

    const $ = (sel)=>document.querySelector(sel);
    function maskEmail(email){
        if(!email || !email.includes('@')) return email || '';
        const [name,domain] = email.split('@');
        if(name.length <= 2) return '*@' + domain;
        return name.slice(0,2) + '*'.repeat(Math.max(1,name.length-2)) + '@' + domain;
    }
    function showToast(msg,isError){
        const toast = $('#toast');
        toast.textContent = msg;
        toast.style.background = isError ? '#e74c3c' : '#2ecc71';
        toast.classList.add('show');
        setTimeout(()=>toast.classList.remove('show'),3000);
    }

    function initProfile(){
        const name = localStorage.getItem(STORAGE_KEYS.name) || DEFAULTS.name;
        const email = localStorage.getItem(STORAGE_KEYS.email) || DEFAULTS.email;
        const phone = localStorage.getItem(STORAGE_KEYS.phone) || '';
        const country = localStorage.getItem(STORAGE_KEYS.country) || '';
        let avatar = localStorage.getItem(STORAGE_KEYS.avatar);

        if(!avatar){
            const randomIndex = Math.floor(Math.random()*DEFAULTS.avatars.length);
            avatar = DEFAULTS.avatars[randomIndex];
            localStorage.setItem(STORAGE_KEYS.avatar, avatar);
        }

        $('#displayName').innerText = name;
        $('#emailMasked').innerText = maskEmail(email);
        $('#phoneDisplay').innerText = phone || '----------';
        $('#countryDisplay').innerText = country || '----------';
        $('#currentAvatar').src = avatar;
        $('#newName').value = name;
        renderAvatarOptions(avatar);
    }

    function renderAvatarOptions(current){
        const wrap = document.getElementById('avatarOptions');
        wrap.innerHTML = '';
        DEFAULTS.avatars.forEach(src=>{
            const label = document.createElement('label');
            label.style.cursor='pointer';
            label.innerHTML = `
        <input type="radio" name="avatar" value="${src}" style="display:none;" ${src===current?'checked':''}>
        <img src="${src}" class="rounded-circle border border-2" style="width:80px;height:80px;cursor:pointer;border-color:${src===current?'lime':'transparent'};">
      `;
            label.querySelector('img').addEventListener('click', (e)=>{
                wrap.querySelectorAll('img').forEach(i=>i.style.borderColor='transparent');
                e.target.style.borderColor='lime';
                label.querySelector('input').checked = true;
                document.getElementById('currentAvatar').src = src;
            });
            wrap.appendChild(label);
        });
    }

    document.getElementById('currentAvatar').addEventListener('click', ()=>{
        const avatarModal = new bootstrap.Modal(document.getElementById('avatarModal'));
        avatarModal.show();
    });

    document.getElementById('avatarForm').addEventListener('submit',(e)=>{
        e.preventDefault();
        const chosen = document.querySelector('input[name="avatar"]:checked');
        if(chosen){
            localStorage.setItem(STORAGE_KEYS.avatar, chosen.value);
            document.getElementById('currentAvatar').src = chosen.value;
            showToast('‚úÖ C·∫≠p nh·∫≠t avatar th√†nh c√¥ng!', false);
            bootstrap.Modal.getInstance(document.getElementById('avatarModal')).hide();
        }
    });

    document.getElementById('saveNameBtn').addEventListener('click', ()=>{
        const newName = document.getElementById('newName').value.trim();
        if(newName){
            localStorage.setItem(STORAGE_KEYS.name, newName);
            document.getElementById('displayName').innerText = newName;
            showToast('‚úÖ ƒê·ªïi t√™n th√†nh c√¥ng!', false);
        }
    });

    document.getElementById('savePhoneBtn').addEventListener('click', ()=>{
        const newPhone = document.getElementById('newPhone').value.trim();
        if(newPhone){
            localStorage.setItem(STORAGE_KEYS.phone, newPhone);
            document.getElementById('phoneDisplay').innerText = newPhone;
            showToast('‚úÖ L∆∞u s·ªë ƒëi·ªán tho·∫°i!', false);
        }
    });

    document.getElementById('saveCountryBtn').addEventListener('click', ()=>{
        const newCountry = document.getElementById('newCountry').value;
        if(newCountry){
            localStorage.setItem(STORAGE_KEYS.country, newCountry);
            document.getElementById('countryDisplay').innerText = newCountry;
            showToast('‚úÖ C·∫≠p nh·∫≠t qu·ªëc gia!', false);
        }
    });

    function isWalletActivated(){
        return localStorage.getItem(STORAGE_KEYS.walletActive) === 'true';
    }
    function updateWalletUI(){
        document.getElementById('walletStatus').textContent = isWalletActivated() ? 'ƒê√£ k√≠ch ho·∫°t' : 'Ch∆∞a k√≠ch ho·∫°t';
    }

    document.addEventListener('DOMContentLoaded', ()=>{
        initProfile();
        updateWalletUI();

        const walletCard = document.getElementById('walletCard');
        const activateModal = new bootstrap.Modal(document.getElementById('activateWalletModal'));

        walletCard.addEventListener('click', ()=>{
            if(isWalletActivated()){
                openPinPopup();
            }else{
                activateModal.show();
            }
        });

        document.getElementById('activateWalletForm').addEventListener('submit', (e)=>{
            e.preventDefault();
            const pin = document.getElementById('pinCode').value;
            if(!/^\d{4}$/.test(pin)){
                showToast('‚ö†Ô∏è M·∫≠t kh·∫©u ph·∫£i g·ªìm ƒë√∫ng 4 ch·ªØ s·ªë!', true);
                return;
            }
            localStorage.setItem(STORAGE_KEYS.walletPin, pin);
            localStorage.setItem(STORAGE_KEYS.walletActive, 'true');
            updateWalletUI();
            activateModal.hide();
            showToast('‚úÖ V√≠ GamePay ƒë√£ ƒë∆∞·ª£c k√≠ch ho·∫°t!', false);
        });

        document.getElementById('verifyPinBtn').addEventListener('click', verifyPin);
        document.getElementById('closePinBtn').addEventListener('click', closePinPopup);
    });

    function openPinPopup(){
        document.getElementById('pinPopup').style.display = 'flex';
        document.getElementById('walletPin').value = '';
        document.getElementById('pinError').textContent = '';
    }
    function closePinPopup(){
        document.getElementById('pinPopup').style.display = 'none';
    }
    function verifyPin(){
        const pin = document.getElementById('walletPin').value.trim();
        const saved = localStorage.getItem(STORAGE_KEYS.walletPin);
        if(pin === saved){
            window.location.href = '/wallet';
        }else{
            document.getElementById('pinError').textContent = 'PIN kh√¥ng ƒë√∫ng. Vui l√≤ng th·ª≠ l·∫°i.';
        }
    }
</script>
</body>
</html>
